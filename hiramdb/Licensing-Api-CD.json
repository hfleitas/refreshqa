{"source":2,"revision":61,"description":null,"createdBy":{"displayName":"Hiram Fleitas","url":"https://devops.universalproperty.com/tfs/UPCIC/_apis/Identities/871c7b7c-c18e-46b4-9ccb-e96e49edf34e","_links":{"avatar":{"href":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"}},"id":"871c7b7c-c18e-46b4-9ccb-e96e49edf34e","uniqueName":"UPCIC\\hfleitas","imageUrl":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ","descriptor":"win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"},"createdOn":"2023-03-07T17:10:21.363Z","modifiedBy":{"displayName":"Hiram Fleitas","url":"https://devops.universalproperty.com/tfs/UPCIC/_apis/Identities/871c7b7c-c18e-46b4-9ccb-e96e49edf34e","_links":{"avatar":{"href":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"}},"id":"871c7b7c-c18e-46b4-9ccb-e96e49edf34e","uniqueName":"UPCIC\\hfleitas","imageUrl":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ","descriptor":"win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"},"modifiedOn":"2023-03-08T01:12:31.047Z","isDeleted":false,"variables":{"system.debug":{"value":"false"}},"variableGroups":[],"environments":[{"id":69,"name":"RefreshQA-LicenseManagement","rank":1,"owner":{"displayName":"Hiram Fleitas","url":"https://devops.universalproperty.com/tfs/UPCIC/_apis/Identities/871c7b7c-c18e-46b4-9ccb-e96e49edf34e","_links":{"avatar":{"href":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"}},"id":"871c7b7c-c18e-46b4-9ccb-e96e49edf34e","uniqueName":"UPCIC\\hfleitas","imageUrl":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ","descriptor":"win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":false,"isNotificationOn":false,"approver":{"displayName":"Hiram Fleitas","url":"https://devops.universalproperty.com/tfs/UPCIC/_apis/Identities/871c7b7c-c18e-46b4-9ccb-e96e49edf34e","_links":{"avatar":{"href":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"}},"id":"871c7b7c-c18e-46b4-9ccb-e96e49edf34e","uniqueName":"UPCIC\\hfleitas","imageUrl":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ","descriptor":"win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"},"id":220}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":true,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":215},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":216}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":1,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{"path":"C:\\Program Files\\PowerShell\\7\\","pwsh":"C:\\Program Files\\PowerShell\\7\\pwsh.exe"},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"1.SaveLatestQABackup","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"## save latest qa backup\n$dir = \"\\\\fldsvm_apps01\\SQLSHARED\\FLDSVRSQA01\\\"\n$filter = \"LicenseManagement_backup_*.bak\"\n$latest = Get-ChildItem -Path $dir -Filter $filter | Sort-Object LastAccessTime -Descending | Select-Object -First 1\n$dest = \"Deployments\\\"\n$to = ($dir + $dest + $latest.name)\n$from = ($dir + $latest.name)\nMove-Item -Path $from -Destination $to\n","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":"c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\\"}},{"environment":{"path":"C:\\Program Files\\PowerShell\\7\\","pwsh":"C:\\Program Files\\PowerShell\\7\\pwsh.exe","sqlcmd":"C:\\Program Files\\Microsoft SQL Server\\Client SDK\\ODBC\\170\\Tools\\Binn\\sqlcmd.exe"},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"2.ScriptOutPermissions","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"Set-Location c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\n\n& 'C:\\Program Files\\Microsoft SQL Server\\Client SDK\\ODBC\\170\\Tools\\Binn\\sqlcmd.exe' -C -SFLDSVRSQA01 -dLicenseManagement -i 0ScriptOutPermissions.sql -o 5ResetDBSecurityPermissions.sql","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":"c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\\"}},{"environment":{"path":"C:\\Program Files\\PowerShell\\7\\","pwsh":"C:\\Program Files\\PowerShell\\7\\pwsh.exe","sqlcmd":"C:\\Program Files\\Microsoft SQL Server\\Client SDK\\ODBC\\170\\Tools\\Binn\\sqlcmd.exe"},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"3.DiffBak","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"import-module dbatools\nSet-DbatoolsConfig -FullName sql.connection.trustcert -Value $true\nSet-Location c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\n\n#run prod diff\nInvoke-DbaQuery -SqlInstance FLDASP01_LG01 -File \".\\0DisableProdJobs.sql\"\nInvoke-DbaQuery -SqlInstance FLDASP01_LG01 -File \".\\1BackupProdDiff.sql\"\n\n#wait for status Success, 15minutes ago\nwhile($val -notmatch '@{run_status=1}')\n{\n    $val = Invoke-DbaQuery -SqlInstance FLDASP01_LG01 -File \".\\1BackupProdDiffStatus.sql\" | select-object run_status\n    Write-Host $val\n    Start-Sleep -Seconds 60\n}\n\n#kill db activity in qa to refresh\nInvoke-DbaQuery -SqlInstance FLDSVRSQA01 -File \".\\1Kill.sql\"\n","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":"c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\\"}},{"environment":{"path":"C:\\Program Files\\PowerShell\\7\\","pwsh":"C:\\Program Files\\PowerShell\\7\\pwsh.exe","sqlcmd":"C:\\Program Files\\Microsoft SQL Server\\Client SDK\\ODBC\\170\\Tools\\Binn\\sqlcmd.exe"},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"4.Refresh","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"import-module dbatools\nSet-DbatoolsConfig -FullName sql.connection.trustcert -Value $true\nSet-Location c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\n\nInvoke-DbaQuery -SqlInstance FLDSVRSQA01 -File \".\\1Kill.sql\"\n\n#drop qa\nInvoke-DbaQuery -SqlInstance FLDSVRSQA01 -Query  'DROP DATABASE IF EXISTS LicenseManagement'\n\nStart-Sleep -Seconds 30\n\n#restore qa from prod\n$RestoreTime = Get-Date \nGet-DbaDbBackupHistory -SqlInstance FLDASP01_LG01 `\n-Database LicenseManagement `\n-Last | Restore-DbaDatabase -SqlInstance FLDSVRSQA01 `\n-DestinationDataDirectory S:\\SQLDATA\\ `\n-DestinationLogDirectory L:\\SQLLOGS\\ `\n-WithReplace | Format-Table -auto | out-file \"OutputRefresh.txt\" -Force\nwrite-host 'STARTED' $RestoreTime ', FINISHED'(get-date)\n","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":"c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\\"}},{"environment":{"path":"C:\\Program Files\\PowerShell\\7\\","pwsh":"C:\\Program Files\\PowerShell\\7\\pwsh.exe","sqlcmd":"C:\\Program Files\\Microsoft SQL Server\\Client SDK\\ODBC\\170\\Tools\\Binn\\sqlcmd.exe"},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"5.EnableJobs","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"#renable jobs\nInvoke-DbaQuery -SqlInstance FLDASP01_LG01 -File \".\\3EnableProdJobs.sql\"","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":"c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\\"}},{"environment":{"path":"C:\\Program Files\\PowerShell\\7\\","pwsh":"C:\\Program Files\\PowerShell\\7\\pwsh.exe","sqlcmd":"C:\\Program Files\\Microsoft SQL Server\\Client SDK\\ODBC\\170\\Tools\\Binn\\sqlcmd.exe"},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"6.ResetQA","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"import-module dbatools\nSet-DbatoolsConfig -FullName sql.connection.trustcert -Value $true\nSet-Location c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\n\n#wait for Online\nwhile($val -match '@{state=0}')\n{\n    $val = Invoke-DbaQuery -SqlInstance FLDSVRSQA01 -File \".\\3DbState.sql\" | select-object state\n    Write-Host $val\n    Start-Sleep -Seconds 60\n}\n\n#echo restore hist\nInvoke-DbaQuery -SqlInstance FLDSVRSQA01 -File \".\\99RestoreHistory.sql\" | format-table -wrap\n\n#reset qa\nInvoke-DbaQuery -SqlInstance FLDSVRSQA01 -File \".\\2TrustWorthyDBOwnerTLogShrink.sql\"\nInvoke-DbaQuery -SqlInstance FLDSVRSQA01 -Database LicenseManagement -File \".\\4ResetData.sql\"\nInvoke-DbaQuery -SqlInstance FLDSVRSQA01 -Database LicenseManagement -File \".\\5ResetDBSecurityPermissions.sql\"\nInvoke-DbaQuery -SqlInstance FLDSVRSQA01 -Database LicenseManagement -File \".\\4SyncLogins.sql\"","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":"c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\\"}},{"environment":{"path":"C:\\Program Files\\PowerShell\\7\\","pwsh":"C:\\Program Files\\PowerShell\\7\\pwsh.exe","sqlcmd":"C:\\Program Files\\Microsoft SQL Server\\Client SDK\\ODBC\\170\\Tools\\Binn\\sqlcmd.exe"},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"7.ShowOutput","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"#import-module dbatools\nSet-Location c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\n\nget-content .\\OutputRefresh.txt","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"true","workingDirectory":"c:\\fleitasarts\\Private\\RefreshQA\\LicenseManagement\\"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":1670,"url":"https://devops.universalproperty.com/tfs/UPCIC/cf11711b-1e22-4dbc-8366-9487a43f71a9/_apis/Release/releases/1670","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://devops.universalproperty.com/tfs/UPCIC/_apis/public/Release/badge/cf11711b-1e22-4dbc-8366-9487a43f71a9/49/69"},{"id":70,"name":"Release API","rank":2,"owner":{"displayName":"Hiram Fleitas","url":"https://devops.universalproperty.com/tfs/UPCIC/_apis/Identities/871c7b7c-c18e-46b4-9ccb-e96e49edf34e","_links":{"avatar":{"href":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"}},"id":"871c7b7c-c18e-46b4-9ccb-e96e49edf34e","uniqueName":"UPCIC\\hfleitas","imageUrl":"https://devops.universalproperty.com/tfs/UPCIC/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ","descriptor":"win.Uy0xLTUtMjEtMzY2NTkzNjY4LTEwMDQ2ODkwMjktMzA5MjkwOTgwNS0xNjc1NQ"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":213}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":214},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":217}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":1,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"Copy Paste","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your powershell commands here.\n\nWrite-Host \"Hello World\"\n\n# Use the environment variables input below to pass secret variables to this script.","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":""}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":0,"url":"https://devops.universalproperty.com/tfs/UPCIC/cf11711b-1e22-4dbc-8366-9487a43f71a9/_apis/Release/releases/0","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://devops.universalproperty.com/tfs/UPCIC/_apis/public/Release/badge/cf11711b-1e22-4dbc-8366-9487a43f71a9/49/70"}],"artifacts":[{"sourceId":"cf11711b-1e22-4dbc-8366-9487a43f71a9:46","type":"Build","alias":"_Licensing-Api-CI","definitionReference":{"artifactSourceDefinitionUrl":{"id":"https://devops.universalproperty.com/tfs/_permalink/_build/index?collectionId=1a2974f6-63b6-433c-9c01-f6f157a4fb89&projectId=cf11711b-1e22-4dbc-8366-9487a43f71a9&definitionId=46","name":""},"defaultVersionBranch":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionTags":{"id":"","name":""},"defaultVersionType":{"id":"latestType","name":"Latest"},"definition":{"id":"46","name":"Licensing-Api-CI"},"definitions":{"id":"","name":""},"IsMultiDefinitionType":{"id":"False","name":"False"},"project":{"id":"cf11711b-1e22-4dbc-8366-9487a43f71a9","name":"Universal"},"repository":{"id":"","name":""}},"isPrimary":true,"isRetained":false}],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"pipelineProcess":{"type":1},"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseNew"},"System.EnvironmentRankLogicVersion":{"$type":"System.String","$value":"2"}},"id":49,"name":"Licensing-Api-CD","path":"\\","projectReference":null,"url":"https://devops.universalproperty.com/tfs/UPCIC/cf11711b-1e22-4dbc-8366-9487a43f71a9/_apis/Release/definitions/49","_links":{"self":{"href":"https://devops.universalproperty.com/tfs/UPCIC/cf11711b-1e22-4dbc-8366-9487a43f71a9/_apis/Release/definitions/49"},"web":{"href":"https://devops.universalproperty.com/tfs/UPCIC/cf11711b-1e22-4dbc-8366-9487a43f71a9/_release?definitionId=49"}}}