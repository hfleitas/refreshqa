{"source":2,"revision":6,"description":null,"createdBy":{"displayName":"Hiram Fleitas","url":"https://spsprodcus5.vssps.visualstudio.com/Ac06b540a-7810-4c33-b288-04a9700770e9/_apis/Identities/1a6ccb8a-a426-62ef-8878-f0e0032eaf49","_links":{"avatar":{"href":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"}},"id":"1a6ccb8a-a426-62ef-8878-f0e0032eaf49","uniqueName":"hiramfleitas@microsoft.com","imageUrl":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5","descriptor":"aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"},"createdOn":"2023-03-12T14:28:40.040Z","modifiedBy":{"displayName":"Hiram Fleitas","url":"https://spsprodcus5.vssps.visualstudio.com/Ac06b540a-7810-4c33-b288-04a9700770e9/_apis/Identities/1a6ccb8a-a426-62ef-8878-f0e0032eaf49","_links":{"avatar":{"href":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"}},"id":"1a6ccb8a-a426-62ef-8878-f0e0032eaf49","uniqueName":"hiramfleitas@microsoft.com","imageUrl":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5","descriptor":"aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"},"modifiedOn":"2023-03-12T14:49:31.980Z","isDeleted":false,"lastRelease":{"id":84,"name":"Release-3","artifacts":[],"_links":{},"description":"","releaseDefinition":{"id":5,"projectReference":null,"_links":{}},"createdOn":"2023-03-12T14:42:03.387Z","createdBy":{"displayName":"Hiram Fleitas","url":"https://spsprodcus5.vssps.visualstudio.com/Ac06b540a-7810-4c33-b288-04a9700770e9/_apis/Identities/1a6ccb8a-a426-62ef-8878-f0e0032eaf49","_links":{"avatar":{"href":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"}},"id":"1a6ccb8a-a426-62ef-8878-f0e0032eaf49","uniqueName":"hiramfleitas@microsoft.com","imageUrl":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5","descriptor":"aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"}},"variables":{},"variableGroups":[],"environments":[{"id":6,"name":"refresh db","rank":1,"owner":{"displayName":"Hiram Fleitas","url":"https://spsprodcus5.vssps.visualstudio.com/Ac06b540a-7810-4c33-b288-04a9700770e9/_apis/Identities/1a6ccb8a-a426-62ef-8878-f0e0032eaf49","_links":{"avatar":{"href":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"}},"id":"1a6ccb8a-a426-62ef-8878-f0e0032eaf49","uniqueName":"hiramfleitas@microsoft.com","imageUrl":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5","descriptor":"aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":16}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":17},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":18}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":1,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"1.SaveLatestQABackup","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"## save latest qa backup\n$dir = \"\\\\hiramsqlgroupdiag.file.core.windows.net\\sqlshared\\hiramdb1\\hiramdb\\FULL\\\"\n$filter = \"*hiramdb*.bak\"\n$latest = Get-ChildItem -Path $dir -Filter $filter | Sort-Object LastAccessTime -Descending | Select-Object -First 1\n$dest = \"deployments\\\"\n$to = (\"\\\\hiramsqlgroupdiag.file.core.windows.net\\sqlshared\\hiramdb1\\\" + $dest + $latest.name)\n$from = ($dir + $latest.name)\nMove-Item -Path $from -Destination $to\n","errorActionPreference":"stop","warningPreference":"default","informationPreference":"default","verbosePreference":"default","debugPreference":"default","progressPreference":"silentlyContinue","failOnStderr":"false","showWarnings":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":"","runScriptInSeparateScope":"false"}},{"environment":{},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"2.ScriptOutPermissions","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"Set-Location c:\\RefreshQA\\\n\nsqlcmd -C -Shiramdb1 -dhiramdb -i 0ScriptOutPermissions.sql -o 5ResetDBSecurityPermissions.sql","errorActionPreference":"stop","warningPreference":"default","informationPreference":"default","verbosePreference":"default","debugPreference":"default","progressPreference":"silentlyContinue","failOnStderr":"false","showWarnings":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":"","runScriptInSeparateScope":"false"}},{"environment":{},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"3.DiffBak","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"Set-Location c:\\RefreshQA\\\n\n#run prod diff\ninvoke-sqlcmd -ServerInstance hiramdb2 -InputFile \".\\0DisableProdJobs.sql\"\ninvoke-sqlcmd -ServerInstance hiramdb2 -InputFile \".\\1BackupProdDiff.sql\"\n\n#wait for status Success, 15minutes ago\nwhile($val -notmatch '@{run_status=1}')\n{\n    $val = invoke-sqlcmd -ServerInstance hiramdb2 -InputFile \".\\1BackupProdDiffStatus.sql\" | select-object run_status\n    Write-Host $val\n    Start-Sleep -Seconds 60\n}\n\n#kill db activity in qa to refresh\ninvoke-sqlcmd -ServerInstance hiramdb1 -InputFile \".\\1Kill.sql\"\n","errorActionPreference":"stop","warningPreference":"default","informationPreference":"default","verbosePreference":"default","debugPreference":"default","progressPreference":"silentlyContinue","failOnStderr":"false","showWarnings":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":"","runScriptInSeparateScope":"false"}},{"environment":{},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"4.Refresh","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"import-module dbatools\nSet-DbatoolsConfig -FullName sql.connection.trustcert -Value $true\nSet-Location c:\\RefreshQA\\\n\ninvoke-sqlcmd -ServerInstance hiramdb1 -InputFile \".\\1Kill.sql\"\n\n#drop qa\ninvoke-sqlcmd -ServerInstance hiramdb1 -Query 'DROP DATABASE IF EXISTS hiramdb'\n\nStart-Sleep -Seconds 30\n\n#restore qa from prod\n$RestoreTime = Get-Date \nGet-DbaDbBackupHistory -SqlInstance hiramdb2 `\n-Database hiramdb `\n-Last | Restore-DbaDatabase -SqlInstance hiramdb1 `\n-DestinationDataDirectory f:\\data\\ `\n-DestinationLogDirectory g:\\logs\\ `\n-WithReplace | Format-Table -auto | out-file \"OutputRefresh.txt\" -Force\nwrite-host 'STARTED' $RestoreTime ', FINISHED'(get-date)\n","errorActionPreference":"stop","warningPreference":"default","informationPreference":"default","verbosePreference":"default","debugPreference":"default","progressPreference":"silentlyContinue","failOnStderr":"false","showWarnings":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":"","runScriptInSeparateScope":"false"}},{"environment":{},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"5.EnableJobs","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"import-module dbatools\nSet-Location c:\\RefreshQA\\\n\n#renable jobs\ninvoke-sqlcmd -ServerInstance hiramdb2 -InputFile \".\\3EnableProdJobs.sql\"","errorActionPreference":"stop","warningPreference":"default","informationPreference":"default","verbosePreference":"default","debugPreference":"default","progressPreference":"silentlyContinue","failOnStderr":"false","showWarnings":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":"","runScriptInSeparateScope":"false"}},{"environment":{},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"6.ResetQA","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"Set-Location c:\\RefreshQA\\\n\n#wait for Online\nwhile($val -match '@{state=0}')\n{\n    $val = invoke-sqlcmd -ServerInstance hiramdb1 -InputFile \".\\3DbState.sql\" | select-object state\n    Write-Host $val\n    Start-Sleep -Seconds 60\n}\n\n#echo restore hist\ninvoke-sqlcmd -ServerInstance hiramdb1 -InputFile \".\\99RestoreHistory.sql\" | format-table -wrap\n\n#reset qa\ninvoke-sqlcmd -ServerInstance hiramdb1 -InputFile \".\\2TrustWorthyDBOwnerTLogShrink.sql\"\ninvoke-sqlcmd -ServerInstance hiramdb1 -Database hiramdb -InputFile \".\\4ResetData.sql\"\ninvoke-sqlcmd -ServerInstance hiramdb1 -Database hiramdb -InputFile \".\\5ResetDBSecurityPermissions.sql\"\ninvoke-sqlcmd -ServerInstance hiramdb1 -Database hiramdb -InputFile \".\\4SyncLogins.sql\"","errorActionPreference":"stop","warningPreference":"default","informationPreference":"default","verbosePreference":"default","debugPreference":"default","progressPreference":"silentlyContinue","failOnStderr":"false","showWarnings":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":"","runScriptInSeparateScope":"false"}},{"environment":{},"taskId":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","version":"2.*","name":"7.ShowOutput","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"retryCountOnTaskFailure":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"Set-Location c:\\RefreshQA\\\n\nget-content .\\OutputRefresh.txt","errorActionPreference":"stop","warningPreference":"default","informationPreference":"default","verbosePreference":"default","debugPreference":"default","progressPreference":"silentlyContinue","failOnStderr":"false","showWarnings":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":"","runScriptInSeparateScope":"false"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":84,"url":"https://vsrm.dev.azure.com/hiramfleitas0814/af0e972e-0d0d-47d2-a30c-f60bf79bb216/_apis/Release/releases/84","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/hiramfleitas0814/_apis/public/Release/badge/af0e972e-0d0d-47d2-a30c-f60bf79bb216/5/6"},{"id":7,"name":"api publish","rank":2,"owner":{"displayName":"Hiram Fleitas","url":"https://spsprodcus5.vssps.visualstudio.com/Ac06b540a-7810-4c33-b288-04a9700770e9/_apis/Identities/1a6ccb8a-a426-62ef-8878-f0e0032eaf49","_links":{"avatar":{"href":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"}},"id":"1a6ccb8a-a426-62ef-8878-f0e0032eaf49","uniqueName":"hiramfleitas@microsoft.com","imageUrl":"https://dev.azure.com/hiramfleitas0814/_apis/GraphProfile/MemberAvatars/aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5","descriptor":"aad.MWE2Y2NiOGEtYTQyNi03MmVmLTg4NzgtZjBlMDAzMmVhZjQ5"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":19}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":20},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":21}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"windows-latest"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":9,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":0,"url":"https://vsrm.dev.azure.com/hiramfleitas0814/af0e972e-0d0d-47d2-a30c-f60bf79bb216/_apis/Release/releases/0","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://vsrm.dev.azure.com/hiramfleitas0814/_apis/public/Release/badge/af0e972e-0d0d-47d2-a30c-f60bf79bb216/5/7"}],"artifacts":[],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseNew"},"IntegrateBoardsWorkItems":{"$type":"System.String","$value":"False"},"IntegrateJiraWorkItems":{"$type":"System.String","$value":"false"}},"id":5,"name":"hiramdb-api-CD","path":"\\","projectReference":null,"url":"https://vsrm.dev.azure.com/hiramfleitas0814/af0e972e-0d0d-47d2-a30c-f60bf79bb216/_apis/Release/definitions/5","_links":{"self":{"href":"https://vsrm.dev.azure.com/hiramfleitas0814/af0e972e-0d0d-47d2-a30c-f60bf79bb216/_apis/Release/definitions/5"},"web":{"href":"https://dev.azure.com/hiramfleitas0814/af0e972e-0d0d-47d2-a30c-f60bf79bb216/_release?definitionId=5"}}}